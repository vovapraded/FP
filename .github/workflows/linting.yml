name: Linting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  clj-kondo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup clj-kondo
      run: |
        curl -sLO https://raw.githubusercontent.com/clj-kondo/clj-kondo/master/script/install-clj-kondo
        chmod +x install-clj-kondo
        ./install-clj-kondo --dir /usr/local/bin --download-dir /tmp --version 2024.11.14
        
    - name: Run clj-kondo linter
      run: |
        cd lab1
        clj-kondo --lint src test --config .clj-kondo/config.edn
      
    - name: Check code formatting (optional)
      run: |
        # Проверяем форматирование кода с помощью cljfmt (если нужно)
        echo "Checking code formatting..."
        # Можно добавить cljfmt позже если потребуется
        
  checkstyle-java:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Check Java files exist
      id: check-java
      run: |
        cd lab1
        if find . -name "*.java" -type f | grep -q .; then
          echo "java_files=true" >> $GITHUB_OUTPUT
        else
          echo "java_files=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Run Checkstyle for Java files
      if: steps.check-java.outputs.java_files == 'true'
      run: |
        # Загружаем checkstyle
        wget https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar
        
        # Создаем базовую конфигурацию checkstyle
        cat > checkstyle.xml << 'EOF'
        <?xml version="1.0"?>
        <!DOCTYPE module PUBLIC
            "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
            "https://checkstyle.org/dtds/configuration_1_3.dtd">
        <module name="Checker">
          <property name="charset" value="UTF-8"/>
          <property name="severity" value="warning"/>
          <property name="fileExtensions" value="java"/>
          
          <module name="TreeWalker">
            <module name="OuterTypeFilename"/>
            <module name="IllegalTokenText">
              <property name="tokens" value="STRING_LITERAL, CHAR_LITERAL"/>
              <property name="format"
                       value="\\u00(09|0(a|A)|0(c|C)|0(d|D)|22|27|5(C|c))|\\(0(10|11|12|14|15|42|47)|134)"/>
              <property name="message"
                       value="Consider using special escape sequence instead of octal value or Unicode escaped value."/>
            </module>
            <module name="AvoidEscapedUnicodeCharacters">
              <property name="allowEscapesForControlCharacters" value="true"/>
              <property name="allowByTailComment" value="true"/>
              <property name="allowNonPrintableEscapes" value="true"/>
            </module>
            <module name="EmptyBlock">
              <property name="option" value="TEXT"/>
              <property name="tokens"
                       value="LITERAL_TRY, LITERAL_FINALLY, LITERAL_IF, LITERAL_ELSE, LITERAL_SWITCH"/>
            </module>
            <module name="NeedBraces"/>
            <module name="LeftCurly"/>
            <module name="RightCurly">
              <property name="id" value="RightCurlySame"/>
              <property name="tokens"
                       value="LITERAL_TRY, LITERAL_CATCH, LITERAL_FINALLY, LITERAL_IF, LITERAL_ELSE,
                              LITERAL_DO"/>
            </module>
            <module name="WhitespaceAround">
              <property name="allowEmptyConstructors" value="true"/>
              <property name="allowEmptyMethods" value="true"/>
              <property name="allowEmptyTypes" value="true"/>
              <property name="allowEmptyLoops" value="true"/>
            </module>
            <module name="OneStatementPerLine"/>
            <module name="MultipleVariableDeclarations"/>
            <module name="ArrayTypeStyle"/>
            <module name="MissingSwitchDefault"/>
            <module name="FallThrough"/>
            <module name="UpperEll"/>
            <module name="ModifierOrder"/>
            <module name="EmptyLineSeparator">
              <property name="allowNoEmptyLineBetweenFields" value="true"/>
            </module>
            <module name="SeparatorWrap">
              <property name="id" value="SeparatorWrapDot"/>
              <property name="tokens" value="DOT"/>
              <property name="option" value="nl"/>
            </module>
            <module name="PackageName">
              <property name="format" value="^[a-z]+(\.[a-z][a-z0-9]*)*$"/>
              <property name="message" value="Package name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="TypeName">
              <property name="message" value="Type name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="MemberName">
              <property name="format" value="^[a-z][a-z0-9][a-zA-Z0-9]*$"/>
              <property name="message" value="Member name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="MethodName">
              <property name="format" value="^[a-z][a-z0-9][a-zA-Z0-9]*$"/>
              <property name="message" value="Method name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="LocalVariableName">
              <property name="tokens" value="VARIABLE_DEF"/>
              <property name="format" value="^[a-z]([a-z0-9][a-zA-Z0-9]*)?$"/>
              <property name="message" value="Local variable name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="ClassTypeParameterName">
              <property name="format" value="(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)"/>
              <property name="message" value="Class type name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="MethodTypeParameterName">
              <property name="format" value="(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)"/>
              <property name="message" value="Method type name ''{0}'' must match pattern ''{1}''."/>
            </module>
            <module name="InterfaceTypeParameterName">
              <property name="format" value="(^[A-Z][0-9]?)$|([A-Z][a-zA-Z0-9]*[T]$)"/>
              <property name="message" value="Interface type name ''{0}'' must match pattern ''{1}''."/>
            </module>
          </module>
        </module>
        EOF
        
        # Запускаем checkstyle для всех Java файлов
        cd lab1
        find . -name "*.java" -type f -exec java -jar ../checkstyle-10.12.4-all.jar -c ../checkstyle.xml {} \;